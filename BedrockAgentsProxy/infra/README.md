# Smart Todo App Infrastructure

This directory contains the AWS CDK infrastructure code for the Smart Todo App.

## Components

The infrastructure consists of the following components:

- **Frontend**: S3 bucket and CloudFront distribution for hosting the React UI
- **Backend**: API Gateway and Lambda functions for the Express.js API
- **Database**: DynamoDB table for storing todos and notes
- **Authentication**: Cognito User Pool for user authentication
- **AI Integration**: Amazon Bedrock Agent for natural language interaction

## Directory Structure

- `/lib` - Main CDK stack and constructs
  - `/constructs` - Reusable CDK constructs
    - `/agents` - Bedrock Agent constructs
    - `/api` - API Gateway and Lambda constructs
    - `/auth` - Cognito authentication constructs
    - `/permissions` - IAM roles and policies
    - `/storage` - DynamoDB table constructs
    - `/ui` - S3 and CloudFront constructs
- `/bin` - CDK app entry point

## IAM Roles

The project uses specific IAM roles for different components:

1. **ExpressApiLambdaRole**: Role for the Express.js API Lambda function with DynamoDB access
2. **ProxyLambdaRole**: Role for the Lambda function that handles Bedrock Agent requests
3. **BedrockAgentRole**: Role for the Bedrock Agent to invoke Lambda functions

## Deployment

To deploy the infrastructure:

```bash
npm run build
npm run deploy
```

This will:
1. Build all packages (API, UI, and infrastructure)
2. Deploy the CDK stack to AWS
3. Update environment files with deployed resource information

## Local Development

For local development:

```bash
npm run dev
```

This starts the API and UI development servers locally.

## Bedrock Agent Integration

The infrastructure includes an Amazon Bedrock Agent that allows users to interact with the todo app using natural language. The agent is configured with:

- OpenAPI schema for defining available operations
- Lambda function for handling agent requests
- Integration with the main API

For more details on the AI integration, see the [AI Integration documentation](../doc/ai-integration.md).

## CDK Nag Integration

This project uses CDK Nag to identify potential security issues and best practice violations in the infrastructure code. CDK Nag performs static analysis on the CloudFormation template generated by CDK.

### How it works

1. CDK Nag is integrated in the `bin/infra.ts` file
2. When you run `cdk synth` or `cdk deploy`, CDK Nag will analyze your stack
3. Any findings will be reported in the console output
4. Suppressions can be added in the `lib/nag-suppressions.ts` file

### Common CDK Nag rules

- **AwsSolutions-IAM4**: IAM roles should not use managed policies
- **AwsSolutions-IAM5**: IAM roles should not use wildcards in policies
- **AwsSolutions-S1**: S3 buckets should have server-side encryption enabled
- **AwsSolutions-S2**: S3 buckets should block public access
- **AwsSolutions-L1**: Lambda functions should specify runtime

### Adding suppressions

To suppress specific findings, use the `NagSuppressions` class:

```typescript
import { NagSuppressions } from 'cdk-nag';

// Suppress at the stack level
NagSuppressions.addStackSuppressions(stack, [
  { id: 'AwsSolutions-IAM4', reason: 'Managed policies are used for demo purposes' },
]);

// Suppress at the resource level
NagSuppressions.addResourceSuppressions(
  resource,
  [
    { id: 'AwsSolutions-IAM5', reason: 'Wildcard permissions needed for specific use case' },
  ],
  true // Apply to all child resources
);
```
